---
import { fetchLumaEvents, type LumaEvent } from '../utils/luma';
import Layout from '../layouts/Layout.astro';

export const prerender = false;

// Get the calendar ID from environment variables
const calendarId = import.meta.env.LUMA_CALENDAR_ID || '';

// Fetch upcoming events
let redirectUrl = '';
let errorMessage = '';

try {
  if (!calendarId || calendarId === 'your-calendar-id') {
    errorMessage = 'Calendar ID not configured';
  } else {
    // Fetch all upcoming events
    const upcomingEvents = await fetchLumaEvents(calendarId, true);
    
    console.log('Total upcoming events:', upcomingEvents.length);
    
    // Filter for "nerd out" events (case-insensitive, search in name and description)
    const nerdOutEvents = upcomingEvents.filter((item: LumaEvent) => {
      const eventName = item.event.name?.toLowerCase() || '';
      const eventDescription = item.event.description?.toLowerCase() || '';
      const searchText = eventName + ' ' + eventDescription;
      
      // Look for various variations
      return searchText.includes('nerd out') || 
             searchText.includes('nerdout') ||
             searchText.includes('nerd-out');
    });
    
    console.log('Found nerd out events:', nerdOutEvents.length);
    
    // Sort by start date to ensure chronological order (closest first)
    nerdOutEvents.sort((a, b) => 
      new Date(a.event.start_at).getTime() - new Date(b.event.start_at).getTime()
    );
    
    if (nerdOutEvents.length > 0) {
      // Get the FIRST (closest/soonest) upcoming event
      const nextEvent = nerdOutEvents[0];
      
      console.log('Nerd out events dates:', nerdOutEvents.map(e => 
        `${e.event.name} - ${new Date(e.event.start_at).toISOString()}`
      ));
      console.log('Redirecting to next event:', nextEvent.event.name);
      console.log('Event URL:', nextEvent.event.url);
      
      // Redirect to the next upcoming event
      if (nextEvent.event.url) {
        return Astro.redirect(nextEvent.event.url, 302);
      }
    } else {
      // Log all event names to help debug
      console.log('All event names:', upcomingEvents.map(e => e.event.name));
      errorMessage = 'No upcoming Nerd Out events found';
    }
  }
} catch (error) {
  console.error('Error fetching nerd out event:', error);
  errorMessage = 'Failed to fetch events';
}

---

<Layout>
  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="text-center">
      <h1 class="font-mono text-9xl font-bold text-purple-600 mb-4">ğŸ¤“</h1>
      <p class="font-sans text-xl text-gray-700 mb-8">No upcoming Nerd Out events</p>
      <a href="/events" class="font-mono text-purple-600 hover:text-purple-800">â† Events</a>
    </div>
  </div>
</Layout>
