---
import Layout from "../layouts/Layout.astro";
import { fetchLumaEvents, formatEventDate, formatEventTime } from "../utils/luma";

// Get calendar ID from environment variables
const CALENDAR_ID = import.meta.env.LUMA_CALENDAR_ID || "your-calendar-id";

// Fetch upcoming and past events
const upcomingEvents = await fetchLumaEvents(CALENDAR_ID, true);
const pastEvents = await fetchLumaEvents(CALENDAR_ID, false);

// Helper function to truncate description
function truncateDescription(description: string, maxLength: number = 400): { text: string, wasTruncated: boolean } {
  if (!description || description.length <= maxLength) {
    return { text: description || '', wasTruncated: false };
  }
  
  // Find the last space before maxLength to avoid cutting words
  const truncated = description.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');
  const cutPoint = lastSpace > 0 ? lastSpace : maxLength;
  
  return {
    text: description.substring(0, cutPoint) + '...',
    wasTruncated: true
  };
}
---

<Layout>
  <div class="pt-24 md:pt-32 pb-16 px-4 md:px-16">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl md:text-4xl font-mono tracking-tighter mb-12">
        Events
      </h1>
      
      <!-- Tabs -->
      <div class="mb-8">
        <div>
          <nav class="flex space-x-8" aria-label="Tabs">
            <button
              data-tab="upcoming"
              class="tab-button border-b-2 border-purple-600 pb-2 text-sm font-mono text-purple-600"
            >
              Upcoming Events
            </button>
            <button
              data-tab="past"
              class="tab-button border-b-2 border-transparent pb-2 text-sm font-mono text-gray-500 hover:text-gray-700 hover:border-gray-300"
            >
              Past Events
            </button>
          </nav>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content" data-tab-content="upcoming">
        <div class="space-y-6">
          {upcomingEvents.length === 0 ? (
            <p class="font-sans text-lg text-gray-700">
              No upcoming events at the moment. Check back soon or join our{" "}
              <a
                href="https://discord.gg/5MEu6njksN"
                class="text-purple-600 hover:text-purple-800 transition-colors"
              >
                Discord
              </a>{" "}
              to stay updated.
            </p>
          ) : (
            upcomingEvents.map((item) => {
              const { text: shortDescription, wasTruncated } = truncateDescription(item.event.description || '');
              return (
                <div class="border-l-4 border-purple-600 pl-4 py-2">
                  <div class="flex gap-4">
                    {item.event.cover_url && (
                      <div class="flex-shrink-0">
                        <img 
                          src={item.event.cover_url} 
                          alt={item.event.name}
                          class="w-32 h-32 md:w-40 md:h-40 object-cover rounded"
                        />
                      </div>
                    )}
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-mono text-gray-900 mb-2">
                        {item.event.name}
                      </h3>
                      <p class="text-sm font-mono text-gray-600 mb-2">
                        {formatEventDate(item.event.start_at, item.event.timezone)} | {formatEventTime(item.event.start_at, item.event.timezone)}
                        {item.event.geo_address_json?.address && ` | ${item.event.geo_address_json.address}`}
                      </p>
                      {shortDescription && (
                        <p class="font-sans text-gray-700">{shortDescription}</p>
                      )}
                    </div>
                    {item.event.url && (
                      <div class="flex-shrink-0 self-center">
                        <div class="bg-purple-600 h-fit translate-0.5">
                          <a
                            href={item.event.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="bg-purple-50 text-purple-600 inline-flex px-4 py-2 -translate-0.5 items-center gap-2 whitespace-nowrap font-mono text-sm hover:bg-purple-100 transition-colors"
                          >
                            Register
                          </a>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      <div class="tab-content hidden" data-tab-content="past">
        <div class="space-y-6">
          {pastEvents.length === 0 ? (
            <p class="font-sans text-lg text-gray-700">
              No past events to display yet.
            </p>
          ) : (
            pastEvents.map((item) => {
              const { text: shortDescription, wasTruncated } = truncateDescription(item.event.description || '');
              return (
                <div class="border-l-4 border-gray-400 pl-4 py-2">
                  <div class="flex gap-4">
                    {item.event.cover_url && (
                      <div class="flex-shrink-0">
                        <img 
                          src={item.event.cover_url} 
                          alt={item.event.name}
                          class="w-32 h-32 md:w-40 md:h-40 object-cover rounded"
                        />
                      </div>
                    )}
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-mono text-gray-900 mb-2">
                        {item.event.name}
                      </h3>
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="text-sm font-mono text-gray-700">
                          {formatEventDate(item.event.start_at, item.event.timezone)}
                        </span>
                        <span class="text-sm font-mono text-gray-400">|</span>
                        <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded font-mono text-sm font-semibold">
                          {formatEventTime(item.event.start_at, item.event.timezone)}
                        </span>
                        {item.event.geo_address_json?.address && (
                          <>
                            <span class="text-sm font-mono text-gray-400">|</span>
                            <span class="text-sm font-mono text-gray-700">
                              {item.event.geo_address_json.address}
                            </span>
                          </>
                        )}
                      </div>
                      {shortDescription && (
                        <p class="font-sans text-gray-700">{shortDescription}</p>
                      )}
                    </div>
                    {item.event.url && (
                      <div class="flex-shrink-0 self-center">
                        <div class="bg-gray-600 h-fit translate-0.5">
                          <a
                            href={item.event.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="bg-gray-50 text-gray-600 inline-flex px-4 py-2 -translate-0.5 items-center gap-2 whitespace-nowrap font-mono text-sm hover:bg-gray-100 transition-colors"
                          >
                            View
                          </a>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');

        // Remove active classes from all buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('border-purple-600', 'text-purple-600');
          btn.classList.add('border-transparent', 'text-gray-500');
        });

        // Add active classes to clicked button
        button.classList.remove('border-transparent', 'text-gray-500');
        button.classList.add('border-purple-600', 'text-purple-600');

        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });

        // Show selected tab content
        const selectedContent = document.querySelector(`[data-tab-content="${tabName}"]`);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
      });
    });
  });
</script>
