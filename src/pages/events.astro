---
import Layout from "../layouts/Layout.astro";
import { fetchLumaEvents, formatEventDate, formatEventTime } from "../utils/luma";

// Get calendar ID from environment variables
const CALENDAR_ID = import.meta.env.LUMA_CALENDAR_ID || "your-calendar-id";

// Fetch upcoming and past events
const upcomingEvents = await fetchLumaEvents(CALENDAR_ID, true);
const pastEvents = await fetchLumaEvents(CALENDAR_ID, false);

// Helper function to truncate description
function truncateDescription(description: string, maxLength: number = 400): { text: string, wasTruncated: boolean } {
  if (!description || description.length <= maxLength) {
    return { text: description || '', wasTruncated: false };
  }
  
  // Find the last space before maxLength to avoid cutting words
  const truncated = description.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');
  const cutPoint = lastSpace > 0 ? lastSpace : maxLength;
  
  return {
    text: description.substring(0, cutPoint) + '...',
    wasTruncated: true
  };
}
---

<Layout>
  <div class="pt-24 md:pt-32 pb-16 px-4 md:px-16">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl md:text-4xl font-mono tracking-tighter mb-12">
        Events
      </h1>
      
      <!-- Tabs -->
      <div class="mb-8">
        <div>
          <nav class="flex space-x-8" aria-label="Tabs">
            <button
              data-tab="upcoming"
              class="tab-button border-b-2 border-purple-600 pb-2 text-sm font-mono text-purple-600"
            >
              Upcoming Events
            </button>
            <button
              data-tab="past"
              class="tab-button border-b-2 border-transparent pb-2 text-sm font-mono text-gray-500 hover:text-gray-700 hover:border-gray-300"
            >
              Past Events
            </button>
          </nav>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content" data-tab-content="upcoming">
        <div class="space-y-6">
          {upcomingEvents.length === 0 ? (
            <p class="font-sans text-lg text-gray-700">
              No upcoming events at the moment. Check back soon or join our{" "}
              <a
                href="https://discord.gg/5MEu6njksN"
                class="text-purple-600 hover:text-purple-800 transition-colors"
              >
                Discord
              </a>{" "}
              to stay updated.
            </p>
          ) : (
            upcomingEvents.map((item) => {
              const { text: shortDescription, wasTruncated } = truncateDescription(item.event.description || '');
              
              // Determine event type based on name
              const isNerdOut = item.event.name.toLowerCase().includes('nerd out');
              const isBuildChill = item.event.name.toLowerCase().includes('build & chill') || 
                                   item.event.name.toLowerCase().includes('build and chill');
              
              // Set colors based on event type
              const borderColor = isNerdOut ? 'border-teal-600' : 'border-purple-600';
              const badgeBg = isNerdOut ? 'bg-teal-100' : 'bg-purple-100';
              const badgeText = isNerdOut ? 'text-teal-700' : 'text-purple-700';
              const buttonShadow = isNerdOut ? 'bg-teal-600' : 'bg-purple-600';
              const buttonBg = isNerdOut ? 'bg-teal-50' : 'bg-purple-50';
              const buttonText = isNerdOut ? 'text-teal-600' : 'text-purple-600';
              const buttonHover = isNerdOut ? 'hover:bg-teal-100' : 'hover:bg-purple-100';
              const titleHoverColor = isNerdOut ? 'hover:text-teal-600' : 'hover:text-purple-600';
              
              return (
                <div class={`border-l-4 ${borderColor} pl-4 py-2`}>
                  {/* Mobile Layout */}
                  <div class="md:hidden">
                    <div class="flex gap-3 mb-3 items-center">
                      {item.event.cover_url && (
                        <div class="flex-shrink-0">
                          <img 
                            src={item.event.cover_url} 
                            alt={item.event.name}
                            class="w-20 h-20 object-cover rounded"
                          />
                        </div>
                      )}
                      <div class="flex-1 min-w-0">
                        <h3 class="text-base font-mono mb-2">
                          {item.event.url ? (
                            <a href={item.event.url} target="_blank" rel="noopener noreferrer" class={`text-gray-900 transition-colors ${titleHoverColor}`}>
                              {item.event.name}
                            </a>
                          ) : (
                            <span class="text-gray-900">{item.event.name}</span>
                          )}
                        </h3>
                        <div class="flex flex-wrap items-center gap-1.5 text-xs">
                          <span class="font-mono text-gray-700">
                            {formatEventDate(item.event.start_at, item.event.timezone)}
                          </span>
                          <span class="font-mono text-gray-400">|</span>
                          <span class={`${badgeBg} ${badgeText} px-2 py-0.5 rounded font-mono font-semibold`}>
                            {formatEventTime(item.event.start_at, item.event.timezone)}
                          </span>
                          {item.event.geo_address_json?.address && (
                            <>
                              <span class="font-mono text-gray-400">|</span>
                              <span class="font-mono text-gray-600">
                                {item.event.geo_address_json.address}
                              </span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                    <div class="space-y-2">
                      {shortDescription && (
                        <p class="font-sans text-sm text-gray-700">{shortDescription}</p>
                      )}
                      {item.event.url && (
                        <div class="flex justify-center">
                          <div class={`${buttonShadow} h-fit translate-0.5`}>
                            <a
                              href={item.event.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              class={`${buttonBg} ${buttonText} inline-flex px-4 py-2 -translate-0.5 items-center gap-2 whitespace-nowrap font-mono text-sm ${buttonHover} transition-colors`}
                            >
                              Join
                            </a>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Desktop Layout */}
                  <div class="hidden md:flex gap-4 items-center">
                    {item.event.cover_url && (
                      <div class="flex-shrink-0">
                        <img 
                          src={item.event.cover_url} 
                          alt={item.event.name}
                          class="w-40 h-40 object-cover rounded"
                        />
                      </div>
                    )}
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-mono mb-2">
                        {item.event.url ? (
                          <a href={item.event.url} target="_blank" rel="noopener noreferrer" class={`text-gray-900 transition-colors ${titleHoverColor}`}>
                            {item.event.name}
                          </a>
                        ) : (
                          <span class="text-gray-900">{item.event.name}</span>
                        )}
                      </h3>
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="text-sm font-mono text-gray-700">
                          {formatEventDate(item.event.start_at, item.event.timezone)}
                        </span>
                        <span class="text-sm font-mono text-gray-400">|</span>
                        <span class={`${badgeBg} ${badgeText} px-2 py-1 rounded font-mono text-sm font-semibold`}>
                          {formatEventTime(item.event.start_at, item.event.timezone)}
                        </span>
                        {item.event.geo_address_json?.address && (
                          <>
                            <span class="text-sm font-mono text-gray-400">|</span>
                            <span class="text-sm font-mono text-gray-700">
                              {item.event.geo_address_json.address}
                            </span>
                          </>
                        )}
                      </div>
                      {shortDescription && (
                        <p class="font-sans text-gray-700">{shortDescription}</p>
                      )}
                    </div>
                    {item.event.url && (
                      <div class="flex-shrink-0 self-center">
                        <div class={`${buttonShadow} h-fit translate-0.5`}>
                          <a
                            href={item.event.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class={`${buttonBg} ${buttonText} inline-flex px-4 py-2 -translate-0.5 items-center gap-2 whitespace-nowrap font-mono text-sm ${buttonHover} transition-colors`}
                          >
                            Join
                          </a>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      <div class="tab-content hidden" data-tab-content="past">
        <div class="space-y-6">
          {pastEvents.length === 0 ? (
            <p class="font-sans text-lg text-gray-700">
              No past events to display yet.
            </p>
          ) : (
            pastEvents.map((item) => {
              const { text: shortDescription, wasTruncated } = truncateDescription(item.event.description || '');
              
              // For past events, keep gray styling regardless of event type
              const borderColor = 'border-gray-400';
              const badgeBg = 'bg-gray-200';
              const badgeText = 'text-gray-700';
              const buttonShadow = 'bg-gray-600';
              const buttonBg = 'bg-gray-50';
              const buttonText = 'text-gray-600';
              const buttonHover = 'hover:bg-gray-100';
              const titleHoverColor = 'hover:text-gray-600';
              
              return (
                <div class={`border-l-4 ${borderColor} pl-4 py-2`}>
                  {/* Mobile Layout */}
                  <div class="md:hidden">
                    <div class="flex gap-3 mb-3 items-center">
                      {item.event.cover_url && (
                        <div class="flex-shrink-0">
                          <img 
                            src={item.event.cover_url} 
                            alt={item.event.name}
                            class="w-20 h-20 object-cover rounded"
                          />
                        </div>
                      )}
                      <div class="flex-1 min-w-0">
                        <h3 class="text-base font-mono mb-2">
                          {item.event.url ? (
                            <a href={item.event.url} target="_blank" rel="noopener noreferrer" class={`text-gray-900 transition-colors ${titleHoverColor}`}>
                              {item.event.name}
                            </a>
                          ) : (
                            <span class="text-gray-900">{item.event.name}</span>
                          )}
                        </h3>
                        <div class="flex flex-wrap items-center gap-1.5 text-xs">
                          <span class="font-mono text-gray-700">
                            {formatEventDate(item.event.start_at, item.event.timezone)}
                          </span>
                          <span class="font-mono text-gray-400">|</span>
                          <span class={`${badgeBg} ${badgeText} px-2 py-0.5 rounded font-mono font-semibold`}>
                            {formatEventTime(item.event.start_at, item.event.timezone)}
                          </span>
                          {item.event.geo_address_json?.address && (
                            <>
                              <span class="font-mono text-gray-400">|</span>
                              <span class="font-mono text-gray-600">
                                {item.event.geo_address_json.address}
                              </span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                    <div class="space-y-2">
                      {shortDescription && (
                        <p class="font-sans text-sm text-gray-700">{shortDescription}</p>
                      )}
                      {item.event.url && (
                        <div class="flex justify-center">
                          <div class={`${buttonShadow} h-fit translate-0.5`}>
                            <a
                              href={item.event.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              class={`${buttonBg} ${buttonText} inline-flex px-4 py-2 -translate-0.5 items-center gap-2 whitespace-nowrap font-mono text-sm ${buttonHover} transition-colors`}
                            >
                              View
                            </a>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Desktop Layout */}
                  <div class="hidden md:flex gap-4 items-center">
                    {item.event.cover_url && (
                      <div class="flex-shrink-0">
                        <img 
                          src={item.event.cover_url} 
                          alt={item.event.name}
                          class="w-40 h-40 object-cover rounded"
                        />
                      </div>
                    )}
                    <div class="flex-1 min-w-0">
                      <h3 class="text-lg font-mono mb-2">
                        {item.event.url ? (
                          <a href={item.event.url} target="_blank" rel="noopener noreferrer" class={`text-gray-900 transition-colors ${titleHoverColor}`}>
                            {item.event.name}
                          </a>
                        ) : (
                          <span class="text-gray-900">{item.event.name}</span>
                        )}
                      </h3>
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <span class="text-sm font-mono text-gray-700">
                          {formatEventDate(item.event.start_at, item.event.timezone)}
                        </span>
                        <span class="text-sm font-mono text-gray-400">|</span>
                        <span class={`${badgeBg} ${badgeText} px-2 py-1 rounded font-mono text-sm font-semibold`}>
                          {formatEventTime(item.event.start_at, item.event.timezone)}
                        </span>
                        {item.event.geo_address_json?.address && (
                          <>
                            <span class="text-sm font-mono text-gray-400">|</span>
                            <span class="text-sm font-mono text-gray-700">
                              {item.event.geo_address_json.address}
                            </span>
                          </>
                        )}
                      </div>
                      {shortDescription && (
                        <p class="font-sans text-gray-700">{shortDescription}</p>
                      )}
                    </div>
                    {item.event.url && (
                      <div class="flex-shrink-0 self-center">
                        <div class={`${buttonShadow} h-fit translate-0.5`}>
                          <a
                            href={item.event.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class={`${buttonBg} ${buttonText} inline-flex px-4 py-2 -translate-0.5 items-center gap-2 whitespace-nowrap font-mono text-sm ${buttonHover} transition-colors`}
                          >
                            View
                          </a>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');

        // Remove active classes from all buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('border-purple-600', 'text-purple-600');
          btn.classList.add('border-transparent', 'text-gray-500');
        });

        // Add active classes to clicked button
        button.classList.remove('border-transparent', 'text-gray-500');
        button.classList.add('border-purple-600', 'text-purple-600');

        // Hide all tab contents
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });

        // Show selected tab content
        const selectedContent = document.querySelector(`[data-tab-content="${tabName}"]`);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
      });
    });
  });
</script>
