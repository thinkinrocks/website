---
import { fetchLumaEvents, type LumaEvent } from '../utils/luma';

export const prerender = false;

// Get the calendar ID from environment variables
const calendarId = import.meta.env.LUMA_CALENDAR_ID || '';

// Fetch upcoming events
let redirectUrl = '';
let errorMessage = '';

try {
  if (!calendarId || calendarId === 'your-calendar-id') {
    errorMessage = 'Calendar ID not configured';
  } else {
    // Fetch all upcoming events
    const upcomingEvents = await fetchLumaEvents(calendarId, true);
    
    console.log('Total upcoming events:', upcomingEvents.length);
    
    // Filter for "build & chill" events (case-insensitive, search in name and description)
    const buildChillEvents = upcomingEvents.filter((item: LumaEvent) => {
      const eventName = item.event.name?.toLowerCase() || '';
      const eventDescription = item.event.description?.toLowerCase() || '';
      const searchText = eventName + ' ' + eventDescription;
      
      // Look for various variations
      return searchText.includes('build & chill') || 
             searchText.includes('build and chill') ||
             searchText.includes('build&chill') ||
             searchText.includes('buildchill') ||
             searchText.includes('build-chill');
    });
    
    console.log('Found build & chill events:', buildChillEvents.length);
    
    // Sort by start date to ensure chronological order (closest first)
    buildChillEvents.sort((a, b) => 
      new Date(a.event.start_at).getTime() - new Date(b.event.start_at).getTime()
    );
    
    if (buildChillEvents.length > 0) {
      // Get the FIRST (closest/soonest) upcoming event
      const nextEvent = buildChillEvents[0];
      
      console.log('Build & chill events dates:', buildChillEvents.map(e => 
        `${e.event.name} - ${new Date(e.event.start_at).toISOString()}`
      ));
      console.log('Redirecting to next event:', nextEvent.event.name);
      console.log('Event URL:', nextEvent.event.url);
      
      // Redirect to the next upcoming event
      if (nextEvent.event.url) {
        return Astro.redirect(nextEvent.event.url, 302);
      }
    } else {
      // Log all event names to help debug
      console.log('All event names:', upcomingEvents.map(e => e.event.name));
      errorMessage = 'No upcoming Build & Chill events found';
    }
  }
} catch (error) {
  console.error('Error fetching build & chill event:', error);
  errorMessage = 'Failed to fetch events';
}

// If we reach here, there was an error or no event found
redirectUrl = '/events';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Build & Chill - Redirecting...</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #0a0a0a;
      color: #fff;
    }
    .container {
      text-align: center;
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    p {
      color: #999;
      margin-bottom: 1.5rem;
    }
    a {
      color: #3b82f6;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    {errorMessage ? (
      <>
        <h1>üõ†Ô∏è Build & Chill</h1>
        <p>{errorMessage}</p>
        <a href="/events">View all events</a>
      </>
    ) : (
      <>
        <h1>Redirecting to Build & Chill...</h1>
        <p>If you're not redirected, <a href={redirectUrl}>click here</a></p>
      </>
    )}
  </div>
</body>
</html>
